<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>闲聊 canal | 入门篇 - 云原生玩码部落</title><meta name=Description content="本文介绍 canal 的使用和概念"><meta property="og:title"content="闲聊 canal | 入门篇"><meta property="og:description"content="本文介绍 canal 的使用和概念"><meta property="og:type"content="article"><meta property="og:url"content="http://blog.funnycode.org.cn/zh-cn/2021/01/04/canal-prepare/"><meta property="og:image"content="http://blog.funnycode.org.cn/logo.png"><meta property="article:published_time"content="2021-01-04T19:11:33+08:00"><meta property="article:modified_time"content="2021-01-05T16:25:11+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://blog.funnycode.org.cn/logo.png"><meta name=twitter:title content="闲聊 canal | 入门篇"><meta name=twitter:description content="本文介绍 canal 的使用和概念"><meta name=application-name content="云原生玩码部落"><meta name=apple-mobile-web-app-title content="云原生玩码部落"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon"type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=http://blog.funnycode.org.cn/zh-cn/2021/01/04/canal-prepare/><link rel=prev href=http://blog.funnycode.org.cn/zh-cn/2021/01/04/mybatis-resulttype-map-error/><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"闲聊 canal | 入门篇","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/blog.funnycode.org.cn\/zh-cn\/2021\/01\/04\/canal-prepare\/"},"image":["http:\/\/blog.funnycode.org.cn\/images\/Apple-Devices-Preview.png"],"genre":"posts","keywords":"java, golang, 模板方法模式","wordcount":2942,"url":"http:\/\/blog.funnycode.org.cn\/zh-cn\/2021\/01\/04\/canal-prepare\/","datePublished":"2021-01-04T19:11:33+08:00","dateModified":"2021-01-05T16:25:11+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"xxxx","logo":"http:\/\/blog.funnycode.org.cn\/images\/me\/logo.png"},"author":{"@type":"Person","name":"铁城"},"description":"本文介绍 canal 的使用和概念"}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':'auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark')&&document.body.setAttribute('theme','dark')</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/zh-cn/ title=云原生玩码部落><span class=header-title-pre><i class="far fa-kiss-wink-heart fa-fw"></i></span><span id=id-1 class=typeit></span></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/zh-cn/posts/>所有文章 </a><a class=menu-item href=/zh-cn/tags/>标签 </a><a class=menu-item href=/zh-cn/categories/>分类 </a><a class=menu-item href=/zh-cn/notes/>笔记 </a><a class=menu-item href=/zh-cn/about/>关于 </a><a class=menu-item href=https://github.com/funnycode-org title=GitHub rel="noopener noreffer"target=_blank><i class="fab fa-github fa-fw"></i></a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item language"title="Select Language">简体中文<i class="fas fa-chevron-right fa-fw"></i>
<select class=language-select id=language-select-desktop onchange="location=this.value"><option value=/zh-cn/2021/01/04/canal-prepare/ selected>简体中文</option></select>
</a><span class="menu-item search"id=search-desktop><input type=text placeholder="Search titles or contents..."id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle"id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw"></i></a><a href=javascript:void(0); class="search-button search-clear"id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw"></i></a><span class="search-button search-loading"id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span></span><a href=javascript:void(0); class="menu-item theme-switch"title="Switch Theme"><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/zh-cn/ title=云原生玩码部落><span class=header-title-pre><i class="far fa-kiss-wink-heart fa-fw"></i></span><span id=id-2 class=typeit></span></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile"id=search-mobile><input type=text placeholder="Search titles or contents..."id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle"id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw"></i></a><a href=javascript:void(0); class="search-button search-clear"id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw"></i></a><span class="search-button search-loading"id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/zh-cn/posts/ title>所有文章</a><a class=menu-item href=/zh-cn/tags/ title>标签</a><a class=menu-item href=/zh-cn/categories/ title>分类</a><a class=menu-item href=/zh-cn/notes/ title>笔记</a><a class=menu-item href=/zh-cn/about/ title>关于</a><a class=menu-item href=https://github.com/funnycode-org title=GitHub rel="noopener noreffer"target=_blank><i class="fab fa-github fa-fw"></i></a><a href=javascript:void(0); class="menu-item theme-switch"title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i></a><a href=javascript:void(0); class=menu-item title="Select Language">简体中文<i class="fas fa-chevron-right fa-fw"></i>
<select class=language-select onchange="location=this.value"><option value=/zh-cn/2021/01/04/canal-prepare/ selected>简体中文</option></select></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">闲聊 canal | 入门篇</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/zh-cn/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>铁城</a></span>&nbsp;<span class=post-category>included in <a href=/zh-cn/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/><i class="far fa-folder fa-fw"></i>设计模式</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2021-01-04>2021-01-04</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;2942 words&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;6 minutes&nbsp;</div></div><div class="details toc"id=toc-static kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content"id=toc-content-static><nav id=TableOfContents><ul><li><a href=#一前言>一、前言</a></li><li><a href=#二原理介绍>二、原理介绍</a><ul><li><a href=#21-mysql-主备复制>2.1 MySQL 主备复制</a></li><li><a href=#22-canal-的工作原理>2.2 canal 的工作原理</a></li><li><a href=#23-canal-架构>2.3 canal 架构</a></li></ul></li><li><a href=#三准备-mysql>三、准备 MySQL</a><ul><li><a href=#31-检查-mysql-是否满足要求>3.1 检查 MySQL 是否满足要求</a></li><li><a href=#32-配置-mysql>3.2 配置 MySQL</a></li><li><a href=#33-设置账号>3.3 设置账号</a></li></ul></li><li><a href=#四运行单机例子>四、运行单机例子</a><ul><li><a href=#41-使用下载包>4.1 使用下载包</a></li><li><a href=#42-镜像>4.2 镜像</a></li><li><a href=#43-intellij-启动>4.3 Intellij 启动</a></li></ul></li><li><a href=#五运行-admin>五、运行 admin</a><ul><li><a href=#51-创建数据库表>5.1 创建数据库表</a></li><li><a href=#52-intellij-启动>5.2 Intellij 启动</a></li><li><a href=#53-镜像启动>5.3 镜像启动</a></li><li><a href=#54-控制台>5.4 控制台</a></li></ul></li><li><a href=#六运行集群例子>六、运行集群例子</a><ul><li><a href=#61-canal-的-ha>6.1 canal 的 HA</a></li><li><a href=#62-通过-admin-配置>6.2 通过 admin 配置</a></li></ul></li><li><a href=#七小结>七、小结</a></li><li><a href=#八参考>八、参考</a></li></ul></nav></div></div><div class=content id=content><h2 id=一前言>一、前言</h2><p>介绍下今天的猪脚 <a href=https://github.com/alibaba/canal/ target=_blank rel="noopener noreffer">canal</a></p><ul><li>官方定位</li></ul><p><strong>基于数据库增量日志解析，提供增量数据订阅&消费，目前主要支持了mysql</strong></p><ul><li>业务场景</li></ul><p>基于日志增量订阅&消费支持的业务：</p><ol><li>数据库镜像</li><li>数据库实时备份</li><li>多级索引 (卖家和买家各自分库索引)</li><li>search build</li><li>业务cache刷新</li><li>价格变化等重要业务消息</li></ol><h2 id=二原理介绍>二、原理介绍</h2><h3 id=21-mysql-主备复制>2.1 MySQL 主备复制</h3><p><img class=lazyload src=/svg/loading.min.svg data-src=https://raw.githubusercontent.com/cityiron/tuchuang/master/blog/cp.01.jpeg data-srcset="https://raw.githubusercontent.com/cityiron/tuchuang/master/blog/cp.01.jpeg, https://raw.githubusercontent.com/cityiron/tuchuang/master/blog/cp.01.jpeg 1.5x, https://raw.githubusercontent.com/cityiron/tuchuang/master/blog/cp.01.jpeg 2x"data-sizes=auto alt=https://raw.githubusercontent.com/cityiron/tuchuang/master/blog/cp.01.jpeg title=主备复制></p><p>从上层来看，复制分成三步：</p><ol><li>master 将改变记录到**二进制日志(binary log)**中（这些记录叫做二进制日志事件，binary log events，可以通过 <code>show binlog events</code> 进行查看）；</li><li>slave 将 master 的 binary log events 拷贝到它的<strong>中继日志(relay log)</strong>；</li><li>slave <strong>重做</strong>中继日志中的事件，将改变反映它自己的数据。</li></ol><h3 id=22-canal-的工作原理>2.2 canal 的工作原理</h3><p><img class=lazyload src=/svg/loading.min.svg data-src=https://raw.githubusercontent.com/cityiron/tuchuang/master/blog/cp.02.jpeg data-srcset="https://raw.githubusercontent.com/cityiron/tuchuang/master/blog/cp.02.jpeg, https://raw.githubusercontent.com/cityiron/tuchuang/master/blog/cp.02.jpeg 1.5x, https://raw.githubusercontent.com/cityiron/tuchuang/master/blog/cp.02.jpeg 2x"data-sizes=auto alt=https://raw.githubusercontent.com/cityiron/tuchuang/master/blog/cp.02.jpeg title=canal></p><p>原理相对比较简单：</p><ol><li>canal 模拟 mysql slave 的交互协议，<strong>伪装自己为 mysql slave</strong>，向 mysql master 发送 dump 协议</li><li>mysql master 收到 dump 请求，开始<strong>推送</strong> binary log 给 slave(也就是canal)</li><li>canal 解析 binary log 对象(原始为 <strong>byte 流</strong>)</li></ol><h3 id=23-canal-架构>2.3 canal 架构</h3><p><img class=lazyload src=/svg/loading.min.svg data-src=https://raw.githubusercontent.com/cityiron/tuchuang/master/blog/cp.03.jpeg data-srcset="https://raw.githubusercontent.com/cityiron/tuchuang/master/blog/cp.03.jpeg, https://raw.githubusercontent.com/cityiron/tuchuang/master/blog/cp.03.jpeg 1.5x, https://raw.githubusercontent.com/cityiron/tuchuang/master/blog/cp.03.jpeg 2x"data-sizes=auto alt=https://raw.githubusercontent.com/cityiron/tuchuang/master/blog/cp.03.jpeg title=architecture></p><p>说明：</p><ul><li>server 代表一个 canal 运行实例，对应于一个 jvm</li><li>instance 对应于一个数据队列 （1个 server 对应 1..n 个 instance)</li></ul><p>instance 模块：</p><ul><li>eventParser (数据源接入，模拟slave协议和master进行交互，协议解析)</li><li>eventSink (Parser和Store链接器，进行数据过滤，加工，分发的工作)</li><li>eventStore (数据存储)</li><li>metaManager (增量订阅&消费信息管理器)</li></ul><blockquote><p>概念还是建议都看看，会方便看源码</p></blockquote><p>对应的源码结构</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://raw.githubusercontent.com/cityiron/tuchuang/master/blog/cp.04.jpg data-srcset="https://raw.githubusercontent.com/cityiron/tuchuang/master/blog/cp.04.jpg, https://raw.githubusercontent.com/cityiron/tuchuang/master/blog/cp.04.jpg 1.5x, https://raw.githubusercontent.com/cityiron/tuchuang/master/blog/cp.04.jpg 2x"data-sizes=auto alt=https://raw.githubusercontent.com/cityiron/tuchuang/master/blog/cp.04.jpg title=sourcecode></p><p>目录结构把每个模块都很清晰的展示出来了，肉眼直接识别（顾名思义）。</p><h2 id=三准备-mysql>三、准备 MySQL</h2><blockquote><p>默认已经安装好 MySQL</p></blockquote><h3 id=31-检查-mysql-是否满足要求>3.1 检查 MySQL 是否满足要求</h3><blockquote><p>Mac 系统</p></blockquote><p><strong>启动</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ sudo support-files/mysql.server start
Starting MySQL
 SUCCESS! 
</code></pre></td></tr></table></div></div><p><strong>连接</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ mysql -u root 
Enter password: 
Welcome to the MySQL monitor.  Commands end with <span class=p>;</span> or <span class=se>\g</span>.
Your MySQL connection id is <span class=m>4</span>
Server version: 5.7.22-log MySQL Community Server <span class=o>(</span>GPL<span class=o>)</span>

Copyright <span class=o>(</span>c<span class=o>)</span> 2000, 2018, Oracle and/or its affiliates. All rights reserved.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type <span class=s1>&#39;help;&#39;</span> or <span class=s1>&#39;\h&#39;</span> <span class=k>for</span> help. Type <span class=s1>&#39;\c&#39;</span> to clear the current input statement.

mysql&gt;
</code></pre></td></tr></table></div></div><p><strong>查看</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-mysql data-lang=mysql><span class=n>mysql</span><span class=o>&gt;</span> <span class=k>show</span> <span class=n>variables</span> <span class=k>like</span> <span class=s1>&#39;%log_bin%&#39;</span><span class=p>;</span>
<span class=o>+---------------------------------+---------------------------------------+</span>
<span class=o>|</span> <span class=n>Variable_name</span>                   <span class=o>|</span> <span class=n>Value</span>                                 <span class=o>|</span>
<span class=o>+---------------------------------+---------------------------------------+</span>
<span class=o>|</span> <span class=n>log_bin</span>                         <span class=o>|</span> <span class=k>ON</span>                                    <span class=o>|</span>
<span class=o>|</span> <span class=n>log_bin_basename</span>                <span class=o>|</span> <span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>local</span><span class=o>/</span><span class=n>mysql</span><span class=o>/</span><span class=n>data</span><span class=o>/</span><span class=n>mysql</span><span class=o>-</span><span class=n>bin</span>       <span class=o>|</span>
<span class=o>|</span> <span class=n>log_bin_index</span>                   <span class=o>|</span> <span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>local</span><span class=o>/</span><span class=n>mysql</span><span class=o>/</span><span class=n>data</span><span class=o>/</span><span class=n>mysql</span><span class=o>-</span><span class=n>bin</span><span class=p>.</span><span class=k>index</span> <span class=o>|</span>
<span class=o>|</span> <span class=n>log_bin_trust_function_creators</span> <span class=o>|</span> <span class=n>OFF</span>                                   <span class=o>|</span>
<span class=o>|</span> <span class=n>log_bin_use_v1_row_events</span>       <span class=o>|</span> <span class=n>OFF</span>                                   <span class=o>|</span>
<span class=o>|</span> <span class=n>sql_log_bin</span>                     <span class=o>|</span> <span class=k>ON</span>                                    <span class=o>|</span>
<span class=o>+---------------------------------+---------------------------------------+</span>
<span class=mi>6</span> <span class=n>rows</span> <span class=k>in</span> <span class=kt>set</span> <span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>01</span> <span class=n>sec</span><span class=p>)</span>		
</code></pre></td></tr></table></div></div><ul><li>log_bin 必须是 ON，如果是 OFF 则需要编辑配置文件 <code>my.cnf</code></li></ul><h3 id=32-配置-mysql>3.2 配置 MySQL</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ cat /etc/my.cnf 
<span class=o>[</span>mysqld<span class=o>]</span>
log-bin<span class=o>=</span>mysql-bin <span class=c1># 开启 binlog</span>
binlog-format<span class=o>=</span>ROW <span class=c1># 选择 ROW 模式</span>
<span class=nv>server_id</span><span class=o>=</span><span class=m>1</span> <span class=c1># 配置 MySQL replaction 需要定义，不要和 canal 的 slaveId 重复</span>
</code></pre></td></tr></table></div></div><ul><li>配置了后需要重启 mysql 服务</li><li>目前 canal 支持所有模式的增量订阅(但配合同步时，因为 statement 只有sql，没有数据，无法获取原始的变更日志，所以一般建议为ROW模式)</li></ul><h3 id=33-设置账号>3.3 设置账号</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-mysql data-lang=mysql><span class=c1>-- 创建账号，可以使用已有账号
</span><span class=c1></span><span class=k>CREATE</span> <span class=k>USER</span> <span class=n>canal</span> <span class=k>IDENTIFIED</span> <span class=k>BY</span> <span class=s1>&#39;canal&#39;</span><span class=p>;</span>  
<span class=c1>-- 授权
</span><span class=c1></span><span class=k>GRANT</span> <span class=k>SELECT</span><span class=p>,</span> <span class=n>REPLICATION</span> <span class=n>SLAVE</span><span class=p>,</span> <span class=n>REPLICATION</span> <span class=n>CLIENT</span> <span class=k>ON</span> <span class=o>*</span><span class=p>.</span><span class=o>*</span> <span class=k>TO</span> <span class=s1>&#39;canal&#39;</span><span class=o>@</span><span class=s1>&#39;%&#39;</span><span class=p>;</span>
<span class=c1>-- GRANT ALL PRIVILEGES ON *.* TO &#39;canal&#39;@&#39;%&#39; ;
</span><span class=c1></span><span class=k>FLUSH</span> <span class=k>PRIVILEGES</span><span class=p>;</span>
</code></pre></td></tr></table></div></div><ul><li>MySQL slave 的权限需要 <code>SELECT, REPLICATION SLAVE, REPLICATION CLIENT</code></li><li>因为 canal 账号后续 admin 模块使用，需要删除和编辑权限，直接用<code>GRANT ALL PRIVILEGES ON *.* TO 'canal'@'%' ;</code> 更方便。</li></ul><h2 id=四运行单机例子>四、运行单机例子</h2><h3 id=41-使用下载包>4.1 使用下载包</h3><p><a href=https://github.com/alibaba/canal/wiki/QuickStart#%E5%90%AF%E5%8A%A8 target=_blank rel="noopener noreffer">参考官方文档</a></p><p>默认配置只需要改 instance 的配置，我这里没有主从的配置，就一台 MySQL，关注下面配置项：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback># 主库的地址
canal.instance.master.address=127.0.0.1:3306
# 数据库账号密码（有 slave 权限）
canal.instance.dbUsername=canal
canal.instance.dbPassword=canal

# 这个你可以自指定，不过大于 v1.0.26+ 会自动创建
# canal.instance.mysql.slaveId=0
</code></pre></td></tr></table></div></div><p>不过如果你的运行环境是单核的，需要将 <code>canal.properties</code> 下的 <code>canal.instance.parser.parallel</code> 设置为 false。</p><p>instance 的名称对应的是文件夹，如下 <code>example</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ ls -l
total <span class=m>48</span>
-rwxrwxrwx@ <span class=m>1</span> tc  staff  <span class=m>5794</span> <span class=m>12</span> <span class=m>28</span> 15:57 canal.properties
-rwxrwxrwx@ <span class=m>1</span> tc  staff   <span class=m>291</span>  <span class=m>8</span> <span class=m>31</span>  <span class=m>2019</span> canal_local.properties
drwxrwxrwx@ <span class=m>5</span> tc  staff   <span class=m>160</span> <span class=m>12</span> <span class=m>28</span> 15:14 example
-rwxrwxrwx@ <span class=m>1</span> tc  staff  <span class=m>3437</span>  <span class=m>2</span> <span class=m>28</span>  <span class=m>2020</span> logback.xml
drwxrwxrwx@ <span class=m>3</span> tc  staff    <span class=m>96</span> <span class=m>11</span> <span class=m>27</span>  <span class=m>2018</span> metrics
drwxrwxrwx@ <span class=m>8</span> tc  staff   <span class=m>256</span>  <span class=m>8</span> <span class=m>22</span> 13:14 spring
-rwxrwxrwx@ <span class=m>1</span> tc  staff  <span class=m>2124</span> <span class=m>12</span> <span class=m>28</span> 16:24 sync_dev.properties
</code></pre></td></tr></table></div></div><p>运行起来后默认是文件模式，会创建文件：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ ls -l
total <span class=m>1912</span>
-rw-r--r--@ <span class=m>1</span> tc  staff  <span class=m>913408</span> <span class=m>12</span> <span class=m>30</span> 13:37 h2.mv.db
-rwxrwxrwx@ <span class=m>1</span> tc  staff    <span class=m>2106</span>  <span class=m>8</span> <span class=m>22</span> 13:14 instance.properties
-rw-r--r--@ <span class=m>1</span> tc  staff     <span class=m>338</span> <span class=m>12</span> <span class=m>30</span> 13:37 meta.dat
</code></pre></td></tr></table></div></div><h3 id=42-镜像>4.2 镜像</h3><p><a href=https://github.com/alibaba/canal/wiki/QuickStart target=_blank rel="noopener noreffer">参考官方文档</a></p><p>下载脚本执行：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>sh run.sh -e canal.auto.scan<span class=o>=</span><span class=nb>false</span> -e canal.destinations<span class=o>=</span>base_test -e canal.instance.master.address<span class=o>=</span>127.0.0.1:3306 -e  canal.instance.dbUsername<span class=o>=</span>canal -e canal.instance.dbPassword<span class=o>=</span>canal -e canal.instance.connectionCharset<span class=o>=</span>UTF-8 -e canal.instance.tsdb.enable<span class=o>=</span><span class=nb>true</span> -e canal.instance.gtidon<span class=o>=</span>false<span class=p>;</span>
</code></pre></td></tr></table></div></div><p>查看镜像的运行情况：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ docker ps
CONTAINER ID   IMAGE                COMMAND                  CREATED              STATUS              PORTS                                                          NAMES
6b022c5f435f   canal/canal-server   <span class=s2>&#34;/alidata/bin/main.s…&#34;</span>   About a minute ago   Up About a minute   0.0.0.0:9100-&gt;9100/tcp, 0.0.0.0:11110-11112-&gt;11110-11112/tcp   canal-server
</code></pre></td></tr></table></div></div><p>查看镜像日志：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ docker logs 6b022c5f435f
<span class=nv>DOCKER_DEPLOY_TYPE</span><span class=o>=</span><span class=nv>VM</span>
<span class=o>==</span>&gt; INIT /alidata/init/02init-sshd.sh
<span class=o>==</span>&gt; EXIT CODE: <span class=nv>0</span>
<span class=o>==</span>&gt; INIT /alidata/init/fix-hosts.py
<span class=o>==</span>&gt; EXIT CODE: <span class=nv>0</span>
<span class=o>==</span>&gt; INIT DEFAULT
Generating SSH1 RSA host key:                              <span class=o>[</span>  OK  <span class=o>]</span>
Starting sshd:                                             <span class=o>[</span>  OK  <span class=o>]</span>
Starting crond:                                            <span class=o>[</span>  OK  <span class=o>]</span>
<span class=o>==</span>&gt; INIT <span class=nv>DONE</span>
<span class=o>==</span>&gt; RUN /home/admin/app.sh
<span class=o>==</span>&gt; START ...
start canal ...
start canal <span class=nv>successful</span>
<span class=o>==</span>&gt; START SUCCESSFUL ...
</code></pre></td></tr></table></div></div><p><code>START SUCCESSFUL ...</code> 表示成功</p><p><u>按手册镜像启动报数据库连接错误</u> （https://github.com/alibaba/canal/issues/1339）</p><h3 id=43-intellij-启动>4.3 Intellij 启动</h3><p>把 <code>canal/deployer/src/main/resources/logback.xml</code> 文件的日志路径改下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-xml data-lang=xml><span class=nt>&lt;File&gt;</span>../logs/${destination}/${destination}.log<span class=nt>&lt;/File&gt;</span>

<span class=nt>&lt;File&gt;</span>/Users/tc/Documents/workspace_2020/canal/logs/${destination}/${destination}.log<span class=nt>&lt;/File&gt;</span>
</code></pre></td></tr></table></div></div><p>找到 <code>com.alibaba.otter.canal.deployer.CanalLauncher#main</code> 然后直接运行即可。</p><p>运行后控制台也没啥日志，可以在 <code>canal/logs</code> 下看到日志。</p><p>正常启动日志：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>2020-12-30 11:14:01.111 <span class=o>[</span>main<span class=o>]</span> INFO  com.alibaba.otter.canal.deployer.CanalLauncher - <span class=c1>## set default uncaught exception handler</span>
2020-12-30 11:14:01.159 <span class=o>[</span>main<span class=o>]</span> INFO  com.alibaba.otter.canal.deployer.CanalLauncher - <span class=c1>## load canal configurations</span>
2020-12-30 11:14:02.266 <span class=o>[</span>main<span class=o>]</span> INFO  com.alibaba.otter.canal.deployer.CanalStarter - <span class=c1>## start the canal server.</span>
2020-12-30 11:14:02.360 <span class=o>[</span>main<span class=o>]</span> INFO  com.alibaba.otter.canal.deployer.CanalController - <span class=c1>## start the canal server[30.11.176.115(30.11.176.115):11111]</span>
2020-12-30 11:14:02.497 <span class=o>[</span>main<span class=o>]</span> INFO  com.alibaba.otter.canal.deployer.CanalStarter - <span class=c1>## the canal server is running now ......</span>
</code></pre></td></tr></table></div></div><h2 id=五运行-admin>五、运行 admin</h2><h3 id=51-创建数据库表>5.1 创建数据库表</h3><p>先要把 admin 项目依赖的数据库创建好</p><ul><li>找到SQL</li></ul><p><img class=lazyload src=/svg/loading.min.svg data-src=cp.05.jpg data-srcset="/zh-cn/2021/01/04/canal-prepare/cp.05.jpg, cp.05.jpg 1.5x, /zh-cn/2021/01/04/canal-prepare/cp.05.jpg 2x"data-sizes=auto alt=/zh-cn/2021/01/04/canal-prepare/cp.05.jpg title=SQL></p><ul><li>初始化SQL</li></ul><p>命令操作</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sql data-lang=sql><span class=o>#</span> <span class=err>连接到数据库</span>
<span class=n>mysql</span> <span class=o>-</span><span class=n>u</span> <span class=n>root</span> <span class=o>-</span><span class=n>p</span>

<span class=o>#</span> <span class=err>导入初始化</span><span class=k>SQL</span>
<span class=o>&gt;</span> <span class=k>source</span> <span class=n>conf</span><span class=o>/</span><span class=n>canal_manager</span><span class=p>.</span><span class=k>sql</span>
</code></pre></td></tr></table></div></div><blockquote><p>一般用 Navicat 操作，直接通过有权限的账号连接上去，然后执行SQL内容即可。</p></blockquote><h3 id=52-intellij-启动>5.2 Intellij 启动</h3><ul><li>运行</li></ul><p>直接启动会报错：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>Caused by: io.ebean.config.BeanNotEnhancedException: Bean class com.alibaba.otter.canal.admin.model.CanalConfig is not enhanced? Check packages specified in ebean.mf. If you are running in IDEA or Eclipse check that the enhancement plugin is installed. See https://ebean.io/docs/trouble-shooting#not-enhanced
	at io.ebeaninternal.server.deploy.BeanDescriptorManager.setEntityBeanClass<span class=o>(</span>BeanDescriptorManager.java:1580<span class=o>)</span>
	at io.ebeaninternal.server.deploy.BeanDescriptorManager.createByteCode<span class=o>(</span>BeanDescriptorManager.java:1445<span class=o>)</span>
	at io.ebeaninternal.server.deploy.BeanDescriptorManager.readDeployAssociations<span class=o>(</span>BeanDescriptorManager.java:1354<span class=o>)</span>
	at io.ebeaninternal.server.deploy.BeanDescriptorManager.readEntityDeploymentAssociations<span class=o>(</span>BeanDescriptorManager.java:770<span class=o>)</span>
	at io.ebeaninternal.server.deploy.BeanDescriptorManager.deploy<span class=o>(</span>BeanDescriptorManager.java:374<span class=o>)</span>
	at io.ebeaninternal.server.core.InternalConfiguration.&lt;init&gt;<span class=o>(</span>InternalConfiguration.java:197<span class=o>)</span>
	at io.ebeaninternal.server.core.DefaultContainer.createServer<span class=o>(</span>DefaultContainer.java:124<span class=o>)</span>
	at io.ebeaninternal.server.core.DefaultContainer.createServer<span class=o>(</span>DefaultContainer.java:35<span class=o>)</span>
	at io.ebean.EbeanServerFactory.createInternal<span class=o>(</span>EbeanServerFactory.java:109<span class=o>)</span>
	at io.ebean.EbeanServerFactory.create<span class=o>(</span>EbeanServerFactory.java:70<span class=o>)</span>
	at com.alibaba.otter.canal.admin.config.EbeanConfig.ebeanServer<span class=o>(</span>EbeanConfig.java:38<span class=o>)</span>
	at com.alibaba.otter.canal.admin.config.EbeanConfig<span class=nv>$$</span>EnhancerBySpringCGLIB<span class=nv>$$</span>1b6fbe49.CGLIB<span class=nv>$ebeanServer$0</span><span class=o>(</span>&lt;generated&gt;<span class=o>)</span>
	at com.alibaba.otter.canal.admin.config.EbeanConfig<span class=nv>$$</span>EnhancerBySpringCGLIB<span class=nv>$$</span>1b6fbe49<span class=nv>$$</span>FastClassBySpringCGLIB<span class=nv>$$</span>3981d1d4.invoke<span class=o>(</span>&lt;generated&gt;<span class=o>)</span>
	at org.springframework.cglib.proxy.MethodProxy.invokeSuper<span class=o>(</span>MethodProxy.java:228<span class=o>)</span>
	at org.springframework.context.annotation.ConfigurationClassEnhancer<span class=nv>$BeanMethodInterceptor</span>.intercept<span class=o>(</span>ConfigurationClassEnhancer.java:361<span class=o>)</span>
	at com.alibaba.otter.canal.admin.config.EbeanConfig<span class=nv>$$</span>EnhancerBySpringCGLIB<span class=nv>$$</span>1b6fbe49.ebeanServer<span class=o>(</span>&lt;generated&gt;<span class=o>)</span>
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0<span class=o>(</span>Native Method<span class=o>)</span>
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke<span class=o>(</span>NativeMethodAccessorImpl.java:62<span class=o>)</span>
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke<span class=o>(</span>DelegatingMethodAccessorImpl.java:43<span class=o>)</span>
	at java.base/java.lang.reflect.Method.invoke<span class=o>(</span>Method.java:566<span class=o>)</span>
	at org.springframework.beans.factory.support.SimpleInstantiationStrategy.instantiate<span class=o>(</span>SimpleInstantiationStrategy.java:154<span class=o>)</span>
	... <span class=m>17</span> common frames omitted
</code></pre></td></tr></table></div></div><blockquote><p>新知识点 ebean</p></blockquote><p>首先需要安装插件：</p><p><img class=lazyload src=/svg/loading.min.svg data-src=cp.06.jpg data-srcset="/zh-cn/2021/01/04/canal-prepare/cp.06.jpg, cp.06.jpg 1.5x, /zh-cn/2021/01/04/canal-prepare/cp.06.jpg 2x"data-sizes=auto alt=/zh-cn/2021/01/04/canal-prepare/cp.06.jpg title=安装插件></p><p>在 <code>Build</code> 下开启 <code>Ebean enhancement</code></p><p><img class=lazyload src=/svg/loading.min.svg data-src=cp.07.png data-srcset="/zh-cn/2021/01/04/canal-prepare/cp.07.png, cp.07.png 1.5x, /zh-cn/2021/01/04/canal-prepare/cp.07.png 2x"data-sizes=auto alt=/zh-cn/2021/01/04/canal-prepare/cp.07.png title=打开build></p><p>正常启动就是熟悉的 springboot 项目的启动日志。</p><ul><li>验证</li></ul><blockquote><p>输入地址 127.0.0.1:8089</p></blockquote><p><img class=lazyload src=/svg/loading.min.svg data-src=cp.08.png data-srcset="/zh-cn/2021/01/04/canal-prepare/cp.08.png, cp.08.png 1.5x, /zh-cn/2021/01/04/canal-prepare/cp.08.png 2x"data-sizes=auto alt=/zh-cn/2021/01/04/canal-prepare/cp.08.png title=首页></p><p>默认密码：admin/123456</p><p><img class=lazyload src=/svg/loading.min.svg data-src=cp.09.png data-srcset="/zh-cn/2021/01/04/canal-prepare/cp.09.png, cp.09.png 1.5x, /zh-cn/2021/01/04/canal-prepare/cp.09.png 2x"data-sizes=auto alt=/zh-cn/2021/01/04/canal-prepare/cp.09.png title=页面></p><h3 id=53-镜像启动>5.3 镜像启动</h3><p><a href=https://github.com/alibaba/canal/wiki/Canal-Admin-Docker target=_blank rel="noopener noreffer">参照官方文档</a></p><p>正常使用一个开源中间件，不可能拿来跑个镜像就完事了，肯定要本地的 IDE 启动查看整个代码流程，所以镜像这块就跳过了。</p><h3 id=54-控制台>5.4 控制台</h3><p>控制页面可以看到：</p><p><img class=lazyload src=/svg/loading.min.svg data-src=cp.10.png data-srcset="/zh-cn/2021/01/04/canal-prepare/cp.10.png, cp.10.png 1.5x, /zh-cn/2021/01/04/canal-prepare/cp.10.png 2x"data-sizes=auto alt=/zh-cn/2021/01/04/canal-prepare/cp.10.png title=server列表></p><p>可以看到启动了一个单节点的 server，它的状态是启动。</p><p><img class=lazyload src=/svg/loading.min.svg data-src=cp.11.png data-srcset="/zh-cn/2021/01/04/canal-prepare/cp.11.png, cp.11.png 1.5x, /zh-cn/2021/01/04/canal-prepare/cp.11.png 2x"data-sizes=auto alt=/zh-cn/2021/01/04/canal-prepare/cp.11.png title=配置instance></p><p>刚开始的时候 instance 列表会是停止状态，<u>正常情况下过会会自动的变成启动</u></p><p><img class=lazyload src=/svg/loading.min.svg data-src=cp.12.png data-srcset="/zh-cn/2021/01/04/canal-prepare/cp.12.png, cp.12.png 1.5x, /zh-cn/2021/01/04/canal-prepare/cp.12.png 2x"data-sizes=auto alt=/zh-cn/2021/01/04/canal-prepare/cp.12.png title=instance列表></p><h2 id=六运行集群例子>六、运行集群例子</h2><h3 id=61-canal-的-ha>6.1 canal 的 HA</h3><p><img class=lazyload src=/svg/loading.min.svg data-src=cp.13.jpeg data-srcset="/zh-cn/2021/01/04/canal-prepare/cp.13.jpeg, cp.13.jpeg 1.5x, /zh-cn/2021/01/04/canal-prepare/cp.13.jpeg 2x"data-sizes=auto alt=/zh-cn/2021/01/04/canal-prepare/cp.13.jpeg title=HA></p><p>分 server 和 client 的 HA</p><ul><li>canal server: 为了减少对 mysql dump 的请求，不同 server 上的 instance 要求同一时间只能有一个处于running，其他的处于 standby 状态.</li><li>canal client: 为了保证有序性，一份 instance 同一时间只能由一个 canal client 进行 get/ack/rollback 操作，否则客户端接收无法保证有序。</li></ul><blockquote><p>也就是说数据库实例的 binglog 是单线程操作的</p></blockquote><p>大致步骤：</p><ol><li>canal server 要启动某个 canal instance 时都先向zookeeper进行一次尝试启动判断 (实现：创建EPHEMERAL节点，谁创建成功就允许谁启动)</li><li>创建 zookeeper 节点成功后，对应的canal server就启动对应的 canal instance，没有创建成功的 canal instance 就会处于standby状态</li><li>一旦 zookeeper 发现 canal server A 创建的节点消失后，立即通知其他的 canal server 再次进行步骤1的操作，重新选出一个 canal server 启动 instance.</li><li>canal client 每次进行 connect 时，会首先向 zookeeper 询问当前是谁启动了 canal instance，然后和其建立链接，一旦链接不可用，会重新尝试 connect.</li></ol><p>canal client 的方式和 canal server 方式类似，也是利用 zookeeper 的抢占 EPHEMERAL 节点的方式进行控制。</p><h3 id=62-通过-admin-配置>6.2 通过 admin 配置</h3><p><strong>新建集群</strong></p><p><img class=lazyload src=/svg/loading.min.svg data-src=cp.14.jpg data-srcset="/zh-cn/2021/01/04/canal-prepare/cp.14.jpg, cp.14.jpg 1.5x, /zh-cn/2021/01/04/canal-prepare/cp.14.jpg 2x"data-sizes=auto alt=/zh-cn/2021/01/04/canal-prepare/cp.14.jpg title=新建></p><ul><li>只需要关心 Zookeeper 的地址和集群的名称</li></ul><p>新建后会在列表页面看到</p><p><img class=lazyload src=/svg/loading.min.svg data-src=cp.15.jpg data-srcset="/zh-cn/2021/01/04/canal-prepare/cp.15.jpg, cp.15.jpg 1.5x, /zh-cn/2021/01/04/canal-prepare/cp.15.jpg 2x"data-sizes=auto alt=/zh-cn/2021/01/04/canal-prepare/cp.15.jpg title=集群列表></p><p><strong>server启动</strong></p><blockquote><p><strong>面向容器无状态的运维</strong></p><p>server 的信息维护除了在 canal-admin 上基于 WebUI 的操作以外，还有更加方便的 auto register 机制，主要针对面向容器化之后可以通过扩容节点，自动完成集群配置的维护和 instance 分流</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback># 是否开启自动注册模式
canal.admin.register.auto = true
# 可以指定默认注册的集群名，如果不指定，默认注册为单机模式
canal.admin.register.cluster = 
</code></pre></td></tr></table></div></div><p>我的配置 <code>canal_local.properties</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>canal.admin.register.auto = true
canal.admin.register.cluster = local_cluster
</code></pre></td></tr></table></div></div><h2 id=七小结>七、小结</h2><ul><li>admin模块启动配置好 cluster、server 和 instance 后，就算宕机也不影响 server 和 client 的交互，因为他们是直接建立的 TCP 连接。</li></ul><p><code>canal.serverMode = tcp</code></p><ul><li>如果没有 admin 模块，无法最简配置启动 server，并且需要有集群配置才能启动 server。</li></ul><p><img class=lazyload src=/svg/loading.min.svg data-src=cp.17.jpg data-srcset="/zh-cn/2021/01/04/canal-prepare/cp.17.jpg, cp.17.jpg 1.5x, /zh-cn/2021/01/04/canal-prepare/cp.17.jpg 2x"data-sizes=auto alt=/zh-cn/2021/01/04/canal-prepare/cp.17.jpg title="集群共享 canal.properties"></p><ul><li>权限配置别漏了</li></ul><p>server 启动，连接上 admin 的时候，需要插入数据，如果授权的时候就用了 <code>GRANT SELECT, REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO 'canal'@'%';</code> 那么默认权限是不够的，启动后日志文件会出现如下错误：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>2020-12-30 10:59:36.573 <span class=o>[</span>main<span class=o>]</span> INFO  com.alibaba.otter.canal.deployer.CanalLauncher - <span class=c1>## set default uncaught exception handler</span>
2020-12-30 10:59:36.609 <span class=o>[</span>main<span class=o>]</span> INFO  com.alibaba.otter.canal.deployer.CanalLauncher - <span class=c1>## load canal configurations</span>
2020-12-30 10:59:37.316 <span class=o>[</span>main<span class=o>]</span> ERROR com.alibaba.otter.canal.deployer.CanalLauncher - <span class=c1>## Something goes wrong when starting up the canal Server:</span>
com.alibaba.otter.canal.common.CanalException: load manager config failed.
Caused by: com.alibaba.otter.canal.common.CanalException: requestGet <span class=k>for</span> canal config error: Error<span class=o>[</span>INSERT <span class=nb>command</span> denied to user <span class=s1>&#39;canal&#39;</span>@<span class=s1>&#39;localhost&#39;</span> <span class=k>for</span> table <span class=s1>&#39;canal_node_server&#39;</span><span class=o>]</span>
</code></pre></td></tr></table></div></div><p>admin 默认配置是 <code>canal</code> 和 <code>canal</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yml data-lang=yml><span class=nt>spring.datasource</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>address</span><span class=p>:</span><span class=w> </span><span class=m>127.0.0.1</span><span class=p>:</span><span class=m>3306</span><span class=w>
</span><span class=w>  </span><span class=nt>database</span><span class=p>:</span><span class=w> </span><span class=l>canal_manager</span><span class=w>
</span><span class=w>  </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>canal</span><span class=w>
</span><span class=w>  </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>canal</span><span class=w>
</span></code></pre></td></tr></table></div></div><h2 id=八参考>八、参考</h2><p><a href=https://github.com/alibaba/canal/wiki/%E7%AE%80%E4%BB%8B target=_blank rel="noopener noreffer">https://github.com/alibaba/canal/wiki/%E7%AE%80%E4%BB%8B</a></p><p><a href=http://dev.mysql.com/doc/refman/5.5/en/binary-log.html target=_blank rel="noopener noreffer">http://dev.mysql.com/doc/refman/5.5/en/binary-log.html</a></p><p><a href=http://www.taobaodba.com/html/474_mysqls-binary-log_details.html target=_blank rel="noopener noreffer">http://www.taobaodba.com/html/474_mysqls-binary-log_details.html</a></p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2021-01-05</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/zh-cn/2021/01/04/canal-prepare/index.md target=_blank>Read Markdown</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter"data-sharer=twitter data-url=http://blog.funnycode.org.cn/zh-cn/2021/01/04/canal-prepare/ data-title="闲聊 canal | 入门篇"data-hashtags=java,golang,模板方法模式><i class="fab fa-twitter fa-fw"></i></a><a href=javascript:void(0); title="Share on Facebook"data-sharer=facebook data-url=http://blog.funnycode.org.cn/zh-cn/2021/01/04/canal-prepare/ data-hashtag=java><i class="fab fa-facebook-square fa-fw"></i></a><a href=javascript:void(0); title="Share on Hacker News"data-sharer=hackernews data-url=http://blog.funnycode.org.cn/zh-cn/2021/01/04/canal-prepare/ data-title="闲聊 canal | 入门篇"><i class="fab fa-hacker-news fa-fw"></i></a><a href=javascript:void(0); title="Share on Line"data-sharer=line data-url=http://blog.funnycode.org.cn/zh-cn/2021/01/04/canal-prepare/ data-title="闲聊 canal | 入门篇"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/line.svg></i></a><a href=javascript:void(0); title="Share on 微博"data-sharer=weibo data-url=http://blog.funnycode.org.cn/zh-cn/2021/01/04/canal-prepare/ data-title="闲聊 canal | 入门篇"><i class="fab fa-weibo fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/zh-cn/tags/java/>java</a>,&nbsp;<a href=/zh-cn/tags/golang/>golang</a>,&nbsp;<a href=/zh-cn/tags/%E6%A8%A1%E6%9D%BF%E6%96%B9%E6%B3%95%E6%A8%A1%E5%BC%8F/>模板方法模式</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/zh-cn/>Home</a></span></section></div><div class=post-nav><a href=/zh-cn/2021/01/04/mybatis-resulttype-map-error/ class=prev rel=prev title=Mybatis反序列化sql查询结果异常><i class="fas fa-angle-left fa-fw"></i>Mybatis反序列化sql查询结果异常</a></div></div><div id=comments><div id=gitalk class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://github.com/gitalk/gitalk></a>Gitalk</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer"title="Hugo 0.76.0">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer"title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i>LoveIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2019 - 2021</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/zh-cn/ target=_blank>xxxx</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer"href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw"></i></a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw"></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/gitalk@1.6.2/dist/gitalk.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/gitalk@1.6.2/dist/gitalk.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.37.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/algoliasearch@4.2.0/dist/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.4.0/sharer.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/typeit@7.0.4/dist/typeit.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:10},comment:{gitalk:{admin:["cityiron"],clientID:"7ebb4aff12c6b5dc4aac",clientSecret:"fdb607f0e7f810a9e2084a2cbed3800f5657dab7",id:"2021-01-04T19:11:33+08:00",owner:"funnycode-org",repo:"funnycode-org.github.io",title:"闲聊 canal | 入门篇"}},data:{"id-1":"云原生玩码部落","id-2":"云原生玩码部落"},search:{algoliaAppID:"PASDMWALPK",algoliaIndex:"index.zh-cn",algoliaSearchKey:"b42948e51daaa93df92381c8e2ac0f93",highlightTag:"em",maxResultLength:10,noResultsFound:"No results found",snippetLength:50,type:"algolia"},typeit:{cursorChar:"|",cursorSpeed:1e3,data:{"id-1":["id-1"],"id-2":["id-2"]},duration:-1,speed:100}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>